{"version":3,"sources":["Api.js"],"names":["async","url","method","requestBody","requestOptions","returnEntireResponse","clientId","await","Session","clientIdAsync","session","UserManager","getSessionAsync","skipValidationToken","process","env","let","headers","sessionSecret","options","maxContentLength","MAX_CONTENT_LENGTH","data","formData","convertedFormData","_convertFormDataToBuffer","getHeaders","response","axios","request","Error","responseBody","responseObj","_","isString","JSON","parse","e","ErrorCode","INVALID_JSON","err","ApiError","code","serverError","_callMethodAsync","Promise","resolve","pipe","concat","encoding","outputPath","progressFunction","retryFunction","promptShown","currentProgress","cancel","token","CancelToken","source","warningTimer","setTimeout","TIMER_DURATION","tmpPath","config","timeout","TIMEOUT","responseType","cancelToken","totalDownloadSize","downloadProgress","on","chunk","length","roundedProgress","Math","floor","clearTimeout","fs","createWriteStream","rename","_downloadAsync","message","_isApiError","_rootBaseUrl","Config","api","scheme","host","_apiBaseUrl","rootBaseUrl","port","ApiClient","static","callMethodAsync","methodName","args","encodeURIComponent","stringify","callPathAsync","path","xdlSchemaAsync","sdkVersion","_schemaCaches","hasOwnProperty","join","__dirname","getAsync","downloadAsync","extract","dotExpoHomeDirectory","UserSettings","Extract","extractAsync","rimraf","sync"],"mappings":"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","file":"../Api.js","sourcesContent":["/**\n * @flow\n */\n\nimport _ from 'lodash';\nimport fs from 'fs-extra';\nimport rimraf from 'rimraf';\nimport path from 'path';\nimport axios from 'axios';\nimport concat from 'concat-stream';\n\nimport { Cacher } from './tools/FsCache';\nimport Config from './Config';\nimport ErrorCode from './ErrorCode';\nimport * as Extract from './Extract';\nimport * as Session from './Session';\nimport UserManager from './User';\nimport UserSettings from './UserSettings';\nimport XDLError from './XDLError';\n\nconst MAX_CONTENT_LENGTH = 100 /* MB */ * 1024 * 1024;\n\nconst TIMER_DURATION = 30000;\nconst TIMEOUT = 3600000;\n\nfunction ApiError(code, message) {\n  let err = new Error(message);\n  // $FlowFixMe error has no property code\n  err.code = code;\n  // $FlowFixMe error has no property _isApiError\n  err._isApiError = true;\n  return err;\n}\n\n// These aren't constants because some commands switch between staging and prod\nfunction _rootBaseUrl() {\n  return `${Config.api.scheme}://${Config.api.host}`;\n}\n\nfunction _apiBaseUrl() {\n  let rootBaseUrl = _rootBaseUrl();\n  if (Config.api.port) {\n    rootBaseUrl += ':' + Config.api.port;\n  }\n  return rootBaseUrl + '/--/api';\n}\n\nasync function _callMethodAsync(\n  url,\n  method,\n  requestBody,\n  requestOptions,\n  returnEntireResponse = false\n): Promise<any> {\n  const clientId = await Session.clientIdAsync();\n  const session = await UserManager.getSessionAsync();\n  const skipValidationToken = process.env['EXPO_SKIP_MANIFEST_VALIDATION_TOKEN'];\n\n  let headers: any = {\n    'Exp-ClientId': clientId,\n  };\n\n  if (skipValidationToken) {\n    headers['Exp-Skip-Manifest-Validation-Token'] = skipValidationToken;\n  }\n\n  if (session) {\n    headers['Expo-Session'] = session.sessionSecret;\n  }\n\n  let options = {\n    url,\n    method: method || 'get',\n    headers,\n    maxContentLength: MAX_CONTENT_LENGTH,\n  };\n\n  if (requestBody) {\n    options = {\n      ...options,\n      data: requestBody,\n    };\n  }\n\n  if (requestOptions) {\n    if (requestOptions.formData) {\n      let convertedFormData = await _convertFormDataToBuffer(requestOptions.formData);\n      let { data } = convertedFormData;\n      options.headers = {\n        ...options.headers,\n        ...requestOptions.formData.getHeaders(),\n      };\n      options = { ...options, data };\n    } else {\n      options = { ...options, ...requestOptions };\n    }\n  }\n  let response = await axios.request(options);\n  if (!response) {\n    throw new Error('Unexpected error: Request failed.');\n  }\n  let responseBody = response.data;\n  var responseObj;\n  if (_.isString(responseBody)) {\n    try {\n      responseObj = JSON.parse(responseBody);\n    } catch (e) {\n      throw new XDLError(\n        ErrorCode.INVALID_JSON,\n        'Invalid JSON returned from API: ' + e + '. Response body: ' + responseBody\n      );\n    }\n  } else {\n    responseObj = responseBody;\n  }\n  if (responseObj.err) {\n    let err = ApiError(responseObj.code || 'API_ERROR', 'API Response Error: ' + responseObj.err);\n    // $FlowFixMe can't add arbitrary properties to error\n    err.serverError = responseObj.err;\n    throw err;\n  } else {\n    return returnEntireResponse ? response : responseObj;\n  }\n}\n\nasync function _convertFormDataToBuffer(formData) {\n  return new Promise(resolve => {\n    formData.pipe(concat({ encoding: 'buffer' }, data => resolve({ data })));\n  });\n}\n\nasync function _downloadAsync(url, outputPath, progressFunction, retryFunction) {\n  let promptShown = false;\n  let currentProgress = 0;\n\n  let { cancel, token } = axios.CancelToken.source();\n\n  let warningTimer = setTimeout(() => {\n    if (retryFunction) {\n      retryFunction(cancel);\n    }\n    promptShown = true;\n  }, TIMER_DURATION);\n\n  const tmpPath = `${outputPath}.download`;\n  const config = {\n    timeout: TIMEOUT,\n    responseType: 'stream',\n    cancelToken: token,\n  };\n  let response = await axios(url, config);\n  await new Promise(resolve => {\n    let totalDownloadSize = response.data.headers['content-length'];\n    let downloadProgress = 0;\n    response.data\n      .on('data', chunk => {\n        downloadProgress += chunk.length;\n        const roundedProgress = Math.floor((downloadProgress / totalDownloadSize) * 100);\n        if (currentProgress !== roundedProgress) {\n          currentProgress = roundedProgress;\n          clearTimeout(warningTimer);\n          if (!promptShown) {\n            warningTimer = setTimeout(() => {\n              if (retryFunction) {\n                retryFunction(cancel);\n              }\n              promptShown = true;\n            }, TIMER_DURATION);\n          }\n          if (progressFunction) {\n            progressFunction(roundedProgress);\n          }\n        }\n      })\n      .on('end', () => {\n        clearTimeout(warningTimer);\n        if (progressFunction && currentProgress !== 100) {\n          progressFunction(100);\n        }\n        resolve();\n      })\n      .pipe(fs.createWriteStream(tmpPath));\n  });\n  await fs.rename(tmpPath, outputPath);\n}\n\nexport default class ApiClient {\n  static host: string = Config.api.host;\n  static port: number = Config.api.port || 80;\n\n  static _schemaCaches = {};\n\n  static async callMethodAsync(\n    methodName: string,\n    args: Array<*>,\n    method: string,\n    requestBody: ?Object,\n    requestOptions: ?Object = {},\n    returnEntireResponse: boolean = false\n  ): Promise<any> {\n    let url =\n      _apiBaseUrl() +\n      '/' +\n      encodeURIComponent(methodName) +\n      '/' +\n      encodeURIComponent(JSON.stringify(args));\n    return _callMethodAsync(url, method, requestBody, requestOptions, returnEntireResponse);\n  }\n\n  static async callPathAsync(\n    path: string,\n    method: ?string,\n    requestBody: ?Object,\n    requestOptions: ?Object = {}\n  ) {\n    let url = _rootBaseUrl() + path;\n    return _callMethodAsync(url, method, requestBody, requestOptions);\n  }\n\n  static async xdlSchemaAsync(sdkVersion) {\n    if (!ApiClient._schemaCaches.hasOwnProperty(sdkVersion)) {\n      ApiClient._schemaCaches[sdkVersion] = new Cacher(\n        async () => {\n          return await ApiClient.callPathAsync(`/--/xdl-schema/${sdkVersion}`);\n        },\n        `schema-${sdkVersion}.json`,\n        0,\n        path.join(__dirname, `../caches/schema-${sdkVersion}.json`)\n      );\n    }\n\n    return await ApiClient._schemaCaches[sdkVersion].getAsync();\n  }\n\n  static async downloadAsync(url, outputPath, options = {}, progressFunction, retryFunction) {\n    if (options.extract) {\n      let dotExpoHomeDirectory = UserSettings.dotExpoHomeDirectory();\n      let tmpPath = path.join(dotExpoHomeDirectory, 'tmp-download-file');\n      await _downloadAsync(url, tmpPath);\n      await Extract.extractAsync(tmpPath, outputPath);\n      rimraf.sync(tmpPath);\n    } else {\n      await _downloadAsync(url, outputPath, progressFunction, retryFunction);\n    }\n  }\n}\n"],"sourceRoot":"/xdl@53.7.2/src"}